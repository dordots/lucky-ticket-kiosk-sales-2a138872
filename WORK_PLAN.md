# תוכנית עבודה מפורטת - שיפורי מערכת כרטיסי מזל

## סקירה כללית
מסמך זה מכיל תוכנית עבודה מפורטת ומסודרת לכל המשימות הנדרשות לשיפור מערכת ניהול כרטיסי מזל.

---

## משימה 1: ניהול מלאי דו-מפלסי (דלפק וכספת)

### תיאור כללי
המלאי מתחלק לשני מיקומים:
- **דלפק** - כרטיסים זמינים למכירה
- **כספת** - כרטיסים לא זמינים למכירה (צריך לפתוח אותם לפני שיהיו זמינים)

### דרישות פונקציונליות

#### 1.1 שינוי מבנה הנתונים
**תיאור:** הוספת שדות חדשים למודל TicketType כדי לתמוך במלאי דו-מפלסי

**שינויים נדרשים:**
- [ ] הוספת שדה `quantity_counter` (כמות בדלפק) - מספר שלם, ברירת מחדל: 0
- [ ] הוספת שדה `quantity_vault` (כמות בכספת) - מספר שלם, ברירת מחדל: 0
- [ ] שדה `quantity` הקיים יהפוך לשדה מחושב: `quantity_counter + quantity_vault`
- [ ] הוספת שדה `is_opened` (בוליאני) - האם הכרטיסים בדלפק פתוחים, ברירת מחדל: false
- [ ] שמירה על תאימות לאחור - אם השדות החדשים לא קיימים, נשתמש בערך של `quantity` הקיים

**קבצים לשינוי:**
- `src/firebase/services/ticketTypes.js` - עדכון פונקציות CRUD
- `src/api/firebaseClient.js` - עדכון אם נדרש
- `src/api/entities.js` - עדכון אם נדרש

#### 1.2 עדכון ממשק ניהול המלאי
**תיאור:** עדכון דף המלאי להצגה ועריכה של מלאי דו-מפלסי

**שינויים נדרשים:**
- [ ] עדכון טבלת המלאי להצגת 3 עמודות:
  - כמות בדלפק (`quantity_counter`)
  - כמות בכספת (`quantity_vault`)
  - סך הכל (`quantity_counter + quantity_vault`)
- [ ] הוספת אינדיקטור ויזואלי (אייקון/תג) לכרטיסים שצריך לפתוח (`is_opened === false`)
- [ ] עדכון טופס עריכת כרטיס:
  - שדה לעריכת כמות בדלפק
  - שדה לעריכת כמות בכספת
  - checkbox לסמן שהכרטיסים פתוחים (`is_opened`)
- [ ] עדכון לוגיקת חישוב מלאי נמוך - רק `quantity_counter` נחשב למכירה

**קבצים לשינוי:**
- `src/pages/Inventory.jsx` - עדכון מלא של הממשק
- `src/components/dashboard/LowStockAlert.jsx` - עדכון לוגיקת התראות

#### 1.3 תכונת העברת מלאי מכספת לדלפק
**תיאור:** יצירת ממשק להעברת כרטיסים מהכספת לדלפק

**שינויים נדרשים:**
- [ ] יצירת דיאלוג/מודל להעברת מלאי:
  - בחירת כרטיס
  - הזנת כמות להעברה
  - כפתור "העבר"
- [ ] בעת העברה:
  - הפחתת `quantity_vault` בכמות שהועברה
  - הוספת `quantity_counter` בכמות שהועברה
  - הגדרת `is_opened` ל-`false` (כי הכרטיסים החדשים לא פתוחים)
  - הצגת הודעה: **"לא לשכוח לפתוח את הכרטיסים"** (Alert/Toast)
- [ ] הוספת כפתור "העבר מכספת לדלפק" בדף המלאי
- [ ] רישום פעולה ביומן ביקורת (AuditLog)

**קבצים לשינוי:**
- `src/pages/Inventory.jsx` - הוספת דיאלוג העברה
- `src/firebase/services/ticketTypes.js` - פונקציה להעברת מלאי
- `src/firebase/services/auditLogs.js` - רישום פעולה

#### 1.4 עדכון מערכת המכירה (POS)
**תיאור:** עדכון מערכת המכירה כך שרק כרטיסים בדלפק (`quantity_counter > 0`) ופתוחים (`is_opened === true`) יוצגו למכירה

**שינויים נדרשים:**
- [ ] עדכון שאילתת כרטיסים במערכת POS:
  - סינון רק כרטיסים עם `quantity_counter > 0`
  - סינון רק כרטיסים עם `is_opened === true`
  - סינון רק כרטיסים עם `is_active === true`
- [ ] עדכון חישוב מלאי במכירה:
  - הפחתת `quantity_counter` בלבד (לא `quantity_vault`)
  - עדכון התראות מלאי נמוך לפי `quantity_counter`
- [ ] עדכון תצוגת מלאי נמוך - רק `quantity_counter` נחשב

**קבצים לשינוי:**
- `src/pages/SellerPOS.jsx` - עדכון לוגיקת סינון וחישוב
- `src/components/pos/TicketGrid.jsx` - עדכון תצוגת מלאי
- `src/components/pos/QuantityDialog.jsx` - עדכון חישוב מקסימום

#### 1.5 עדכון דוחות
**תיאור:** עדכון דוחות להצגת פילוח מלאי (דלפק/כספת)

**שינויים נדרשים:**
- [ ] עדכון דוחות המלאי:
  - הצגת פילוח בין דלפק וכספת
  - התראות על כרטיסים שצריך לפתוח
- [ ] עדכון דוחות מכירות - אין שינוי (מבוסס על `quantity_counter`)

**קבצים לשינוי:**
- `src/pages/Reports.jsx` - עדכון תצוגת דוחות

---

## משימה 2: ייבוא כרטיסים מאתר מפעל הפיס

### תיאור כללי
יצירת מערכת ייבוא אוטומטית/חצי-אוטומטית של כל הכרטיסים מאתר מפעל הפיס, כולל תמונות, שמות, מחירים ופרטים נוספים.

### דרישות פונקציונליות

#### 2.1 מחקר וניתוח מבנה הנתונים
**תיאור:** הבנת המבנה המדויק של הנתונים מאתר מפעל הפיס

**שינויים נדרשים:**
- [ ] המתנה לפרטים מהמשתמש על המבנה המדויק של הנתונים
- [ ] תיעוד המבנה:
  - שדות זמינים (שם, מחיר, תמונה, וכו')
  - פורמט הנתונים (JSON, HTML, API, וכו')
  - URL/endpoint לייבוא
  - תדירות עדכון נדרשת

**קבצים לשינוי:**
- יצירת מסמך תיעוד: `PAIS_IMPORT_SPEC.md`

#### 2.2 יצירת סקריפט/API לייבוא
**תיאור:** יצירת כלי לייבוא הנתונים מאתר מפעל הפיס

**שינויים נדרשים:**
- [ ] יצירת סקריפט Node.js לייבוא:
  - קריאת נתונים מאתר מפעל הפיס
  - פרסור הנתונים
  - שמירה ב-Firebase
- [ ] או יצירת API endpoint לייבוא (אם נדרש)
- [ ] טיפול בשגיאות ו-retry logic
- [ ] לוגים מפורטים

**קבצים לשינוי:**
- `scripts/import-pais-tickets.js` - סקריפט חדש
- `package.json` - הוספת פקודה `npm run import-pais`

#### 2.3 עדכון כרטיסים קיימים
**תיאור:** עדכון כרטיסים קיימים במקום יצירת כפילויות

**שינויים נדרשים:**
- [ ] לוגיקה לזיהוי כרטיסים קיימים (לפי שם או ID)
- [ ] עדכון כרטיסים קיימים במקום יצירת חדשים
- [ ] עדכון תמונות, מחירים ופרטים אחרים
- [ ] שמירה על `quantity_counter` ו-`quantity_vault` הקיימים

**קבצים לשינוי:**
- `scripts/import-pais-tickets.js` - לוגיקת עדכון

#### 2.4 ממשק ניהול ייבוא (אופציונלי)
**תיאור:** יצירת ממשק משתמש לייבוא ידני/אוטומטי

**שינויים נדרשים:**
- [ ] דף/דיאלוג לייבוא כרטיסים
- [ ] כפתור "ייבא כרטיסים מאתר מפעל הפיס"
- [ ] תצוגת התקדמות ייבוא
- [ ] דוח על כרטיסים שיובאו/עודכנו

**קבצים לשינוי:**
- `src/pages/Inventory.jsx` - הוספת כפתור ייבוא
- או `src/pages/PaisImport.jsx` - דף נפרד לייבוא

---

## משימה 3: תהליך און-בורדינג ראשוני לזכיין

### תיאור כללי
כאשר זכיין נכנס למערכת בפעם הראשונה, הוא צריך לעבור תהליך הגדרה ראשונית שבו הוא מגדיר את המלאי ההתחלתי והגדרות נוספות.

### דרישות פונקציונליות

#### 3.1 זיהוי זכיין חדש
**תיאור:** זיהוי מתי זכיין נכנס בפעם הראשונה

**שינויים נדרשים:**
- [x] הוספת שדה `onboarding_completed` למשתמש (boolean, ברירת מחדל: false)
- [x] הוספת שדה `onboarding_completed_date` (timestamp)
- [x] בדיקה בכניסה למערכת - אם `onboarding_completed === false`, הפניה לאון-בורדינג

**קבצים לשינוי:**
- `src/firebase/services/users.js` - עדכון מבנה משתמש
- `src/pages/Layout.jsx` או `src/App.jsx` - לוגיקת הפניה

#### 3.2 יצירת דף און-בורדינג
**תיאור:** יצירת דף מודרך להגדרה ראשונית

**שינויים נדרשים:**
- [x] יצירת דף `Onboarding.jsx` עם מספר שלבים:
  - **שלב 1: ברוכים הבאים** - הסבר על המערכת
  - **שלב 2: הגדרת מלאי התחלתי** - הזנת כמות התחלתית לכל כרטיס
  - **שלב 3: הגדרת עמלה** (אופציונלי - ראה משימה 5)
  - **שלב 4: סיום** - סיכום והשלמת התהליך
- [x] ניווט בין שלבים (קודם/הבא/דלג)
- [x] שמירת התקדמות (אפשר לחזור מאוחר יותר)
- [x] עיצוב ידידותי ומודרני

**קבצים לשינוי:**
- `src/pages/Onboarding.jsx` - דף חדש
- `src/App.jsx` - הוספת route
- `src/pages/Layout.jsx` - לוגיקת הפניה

#### 3.3 הגדרת מלאי התחלתי
**תיאור:** ממשק להזנת המלאי ההתחלתי

**שינויים נדרשים:**
- [x] טעינת כל סוגי הכרטיסים הזמינים (כולל כרטיסי מפעל הפיס)
- [x] טבלה/רשימה עם כל הכרטיסים:
  - שם כרטיס
  - תמונה (אם קיימת)
  - שדה להזנת כמות בדלפק (`quantity_counter`)
  - שדה להזנת כמות בכספת (`quantity_vault`)
  - checkbox לסמן שהכרטיסים בדלפק פתוחים (`is_opened`)
- [x] אפשרות להזין 0 (לא מתחיל עם כרטיס זה)
- [x] שמירה - עדכון כל הכרטיסים ב-Firebase
- [x] ולידציה - לפחות כרטיס אחד צריך להיות במלאי

**קבצים לשינוי:**
- `src/pages/Onboarding.jsx` - שלב המלאי
- `src/firebase/services/ticketTypes.js` - עדכון כמות

#### 3.4 השלמת און-בורדינג
**תיאור:** סיום התהליך ועדכון סטטוס

**שינויים נדרשים:**
- [x] כפתור "סיים והתחל לעבוד"
- [x] עדכון `onboarding_completed = true` במשתמש
- [x] עדכון `onboarding_completed_date`
- [x] הפניה לדף הבית/דשבורד
- [x] רישום ביומן ביקורת

**קבצים לשינוי:**
- `src/pages/Onboarding.jsx` - שלב סיום
- `src/firebase/services/users.js` - עדכון משתמש

---

## משימה 4: עדכון מלאי לפי חבילות

### תיאור כללי
לפעמים לא יודעים את המספר המדויק של כרטיסים, אלא רק כמה חבילות נוספו. מספר הכרטיסים בכל חבילה קבוע לפי סוג הכרטיס (`default_quantity_per_package`).

### דרישות פונקציונליות

#### 4.1 ממשק עדכון מלאי בחבילות
**תיאור:** יצירת ממשק ייעודי לעדכון מלאי לפי חבילות

**שינויים נדרשים:**
- [ ] יצירת דיאלוג/מודל "הוספת חבילות" בדף המלאי:
  - בחירת כרטיס
  - הצגת `default_quantity_per_package` של הכרטיס
  - שדה להזנת מספר חבילות
  - חישוב אוטומטי: `מספר חבילות × default_quantity_per_package`
  - בחירת יעד: דלפק או כספת
  - כפתור "הוסף"
- [ ] הוספת כפתור "הוסף חבילות" בדף המלאי (ליד כל כרטיס או כפתור כללי)
- [ ] ולידציה:
  - `default_quantity_per_package` חייב להיות מוגדר
  - מספר חבילות חייב להיות חיובי

**קבצים לשינוי:**
- `src/pages/Inventory.jsx` - הוספת דיאלוג חבילות
- `src/components/ui/dialog.jsx` - שימוש קיים

#### 4.2 לוגיקת עדכון
**תיאור:** עדכון המלאי לפי חישוב החבילות

**שינויים נדרשים:**
- [ ] חישוב כמות: `packages × default_quantity_per_package`
- [ ] עדכון המלאי:
  - אם יעד = דלפק: `quantity_counter += כמות`
  - אם יעד = כספת: `quantity_vault += כמות`
- [ ] אם הוספה לדלפק: `is_opened = false` (כי החבילות החדשות לא פתוחות)
- [ ] הצגת הודעה: "לא לשכוח לפתוח את הכרטיסים" (אם הוספה לדלפק)
- [ ] רישום ביומן ביקורת

**קבצים לשינוי:**
- `src/pages/Inventory.jsx` - לוגיקת עדכון
- `src/firebase/services/ticketTypes.js` - עדכון מלאי
- `src/firebase/services/auditLogs.js` - רישום

#### 4.3 אינדיקציה ויזואלית
**תיאור:** הצגת מידע על חבילות בכרטיס

**שינויים נדרשים:**
- [ ] בדף המלאי - הצגת `default_quantity_per_package` (אם מוגדר)
- [ ] אינדיקציה ויזואלית לכרטיסים עם `default_quantity_per_package` מוגדר
- [ ] הוספת כלי עזר/טולטיפ: "ניתן לעדכן לפי חבילות"

**קבצים לשינוי:**
- `src/pages/Inventory.jsx` - תצוגה

---

## משימה 5: הגדרת עמלה באון-בורדינג

### תיאור כללי
בתהליך האון-בורדינג, זכיין יכול להגדיר את גובה העמלה שלו. העמלה תשמש לחישוב רווחים אישיים בדוחות. אפשר לדלג ולהגדיר מאוחר יותר.

### דרישות פונקציונליות

#### 5.1 הוספת שדה עמלה למשתמש
**תיאור:** שמירת גובה העמלה במשתמש

**שינויים נדרשים:**
- [ ] הוספת שדה `commission_rate` למשתמש (מספר עשרוני, 0-100, אחוזים)
- [ ] הוספת שדה `commission_set` (boolean) - האם העמלה הוגדרה
- [ ] עדכון מבנה משתמש ב-Firebase

**קבצים לשינוי:**
- `src/firebase/services/users.js` - עדכון מבנה
- `src/api/firebaseClient.js` - עדכון אם נדרש

#### 5.2 שלב עמלה באון-בורדינג
**תיאור:** הוספת שלב להגדרת עמלה בתהליך האון-בורדינג

**שינויים נדרשים:**
- [ ] הוספת שלב 3 באון-בורדינג: "הגדרת עמלה"
- [ ] ממשק:
  - הסבר: "הגדר את גובה העמלה שלך (באחוזים) כדי לראות את הרווחים האישיים שלך בדוחות"
  - שדה להזנת עמלה (0-100, עם %)
  - דוגמה: "אם העמלה שלך היא 15%, תקבל 15% מכל מכירה"
  - כפתור "דלג - אגדיר מאוחר יותר"
  - כפתור "המשך"
- [ ] ולידציה:
  - עמלה חייבת להיות בין 0-100
  - אפשר לדלג (לא חובה)
- [ ] שמירה:
  - אם הוזנה: `commission_rate = ערך`, `commission_set = true`
  - אם דילג: `commission_set = false`, `commission_rate = null`

**קבצים לשינוי:**
- `src/pages/Onboarding.jsx` - שלב עמלה

#### 5.3 עדכון דוחות עם רווחים אישיים
**תיאור:** הצגת רווחים אישיים בדוחות לזכיין

**שינויים נדרשים:**
- [ ] בדף הדוחות:
  - אם `commission_set === true`:
    - חישוב רווח אישי: `מכירות × (commission_rate / 100)`
    - הצגת כרטיס "רווח אישי" עם הסכום
    - הצגת גרף רווחים אישיים (אם רלוונטי)
  - אם `commission_set === false`:
    - הצגת הודעה: "הגדר עמלה כדי לראות את הרווחים האישיים שלך"
    - כפתור "הגדר עמלה עכשיו"
- [ ] עדכון דוחות מכירות - הוספת עמודה "רווח אישי" (אם רלוונטי)

**קבצים לשינוי:**
- `src/pages/Reports.jsx` - עדכון דוחות
- `src/components/dashboard/StatsCard.jsx` - כרטיס רווח אישי (אם קיים)

#### 5.4 הגדרת עמלה בהגדרות
**תיאור:** אפשרות להגדיר/לעדכן עמלה בדף ההגדרות

**שינויים נדרשים:**
- [ ] בדף ההגדרות:
  - סעיף "עמלה"
  - שדה להזנת עמלה
  - כפתור "שמור"
  - הצגת עמלה נוכחית (אם מוגדרת)
- [ ] עדכון `commission_rate` ו-`commission_set` במשתמש

**קבצים לשינוי:**
- `src/pages/Settings.jsx` - הוספת סעיף עמלה

---

## סדר ביצוע מומלץ

1. **משימה 1** - ניהול מלאי דו-מפלסי (דלפק וכספת)
   - בסיס לכל המשימות האחרות
   - משפיע על כל המערכת

2. **משימה 4** - עדכון מלאי לפי חבילות
   - תלוי במשימה 1
   - יחסית פשוטה

3. **משימה 3** - תהליך און-בורדינג ראשוני
   - תלוי במשימה 1 (מלאי דו-מפלסי)
   - חשוב לזכיינים חדשים

4. **משימה 5** - הגדרת עמלה באון-בורדינג
   - תלוי במשימה 3 (און-בורדינג)
   - יחסית פשוטה

5. **משימה 2** - ייבוא כרטיסים מאתר מפעל הפיס
   - תלוי במידע מהמשתמש
   - יכולה להתבצע במקביל למשימות אחרות

---

## הערות טכניות

### מבנה נתונים מוצע

#### TicketType (עדכון)
```javascript
{
  // שדות קיימים...
  quantity_counter: number,      // כמות בדלפק
  quantity_vault: number,         // כמות בכספת
  is_opened: boolean,             // האם הכרטיסים בדלפק פתוחים
  default_quantity_per_package: number, // כמות בכל חבילה (קיים)
  // quantity יהפוך למחושב: quantity_counter + quantity_vault
}
```

#### User (עדכון)
```javascript
{
  // שדות קיימים...
  onboarding_completed: boolean,
  onboarding_completed_date: timestamp,
  commission_rate: number,       // 0-100 (אחוזים)
  commission_set: boolean,       // האם העמלה הוגדרה
}
```

### Indexes נדרשים ב-Firebase
- `ticketTypes`: `kiosk_id`, `is_active`, `quantity_counter`
- `users`: `onboarding_completed`, `commission_set`

---

## בדיקות נדרשות

לכל משימה:
- [ ] בדיקת פונקציונליות בסיסית
- [ ] בדיקת edge cases
- [ ] בדיקת תאימות לאחור
- [ ] בדיקת ביצועים
- [ ] בדיקת UX/UI

---

## תיעוד נדרש

- [ ] עדכון README עם תכונות חדשות
- [ ] תיעוד API/פונקציות חדשות
- [ ] מדריך למשתמש (אופציונלי)

---

**תאריך יצירה:** 2024
**סטטוס:** בתכנון
**עדכון אחרון:** 2024

